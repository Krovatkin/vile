<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Browser</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- GLightbox CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css">
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="w-full max-w-none mx-4 md:w-3/4 md:max-w-4xl md:mx-auto">
        <!-- Tabs Container -->
        <div class="tabs tabs-boxed mb-4 flex-wrap">
            <div id="tabsContainer" class="flex flex-wrap gap-1"></div>
            <button id="addTabBtn" class="btn btn-sm btn-circle btn-outline ml-2">+</button>
        </div>

        <!-- Tab Content Container -->
        <div id="tabContentContainer"></div>
    </div>

    <!-- GLightbox JS -->
    <script src="https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js"></script>

    <script>
        // Global state
        let tabs = new Map();
        let activeTabId = null;
        let tabCounter = 0;
        let lightbox;

        // Tab state structure
        class TabState {
            constructor(id, path = '') {
                this.id = id;
                this.path = path;
                this.ws = null;
                this.hasFolders = false;
                this.hasFiles = false;
                this.dividerAdded = false;
            }
        }

        // Utility functions (same as before)
        function isImageFile(filename) {
            const imageExtensions = ['.jpg', '.jpeg', '.png'];
            const ext = filename.toLowerCase().substring(filename.lastIndexOf('.'));
            return imageExtensions.includes(ext);
        }

        function getFileIcon(filename) {
            if (isImageFile(filename)) {
                return `
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                    </svg>
                `;
            } else {
                return `
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                    </svg>
                `;
            }
        }

        function reinitializeLightbox() {
            if (lightbox) {
                lightbox.destroy();
            }
            lightbox = GLightbox({
                selector: '.glightbox',
                touchNavigation: true,
                loop: true,
                autoplayVideos: false
            });
        }

        // Templates
        const folderTemplate = (name, path) => `
            <li>
                <a href="#" onclick="navigateToFolder('${path.replace(/'/g, "\\'")}'); return false;" class="text-yellow-600 hover:bg-yellow-50">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"></path>
                    </svg>
                    ${name}
                </a>
            </li>
        `;

        const fileTemplate = (name, path) => {
            const isImage = isImageFile(name);
            const colorClass = isImage ? 'text-green-600 hover:bg-green-50' : 'text-blue-600 hover:bg-blue-50';
            const icon = getFileIcon(name);

            if (isImage) {
                const imageUrl = `/image/${path}`;
                return `
                    <li>
                        <a href="${imageUrl}" class="glightbox ${colorClass}" data-gallery="gallery" data-title="${name}">
                            ${icon}
                            ${name} üñºÔ∏è 
                        </a>
                    </li>
                `;
            } else {
                return `
                    <li>
                        <a href="#" class="${colorClass}">
                            ${icon}
                            ${name}
                        </a>
                    </li>
                `;
            }
        };

        const dividerTemplate = () => `<div class="divider my-1"></div>`;

        // Tab management
        function createTab(path = '') {
            const tabId = `tab-${++tabCounter}`;
            const tab = new TabState(tabId, path);
            tabs.set(tabId, tab);
            
            renderTab(tab);
            renderTabContent(tab);
            switchToTab(tabId);
            
            return tab;
        }

        function renderTab(tab) {
            const displayPath = tab.path === '' ? '/' : '/' + tab.path;
            const tabElement = document.createElement('div');
            tabElement.className = 'tab tab-bordered flex items-center gap-2';
            tabElement.id = `tab-header-${tab.id}`;
            tabElement.innerHTML = `
                <span onclick="switchToTab('${tab.id}')" class="cursor-pointer">üìÅ ${displayPath}</span>
                <button onclick="closeTab('${tab.id}')" class="btn btn-xs btn-circle btn-ghost">√ó</button>
            `;
            
            document.getElementById('tabsContainer').appendChild(tabElement);
        }

        function renderTabContent(tab) {
            const contentElement = document.createElement('div');
            contentElement.id = `tab-content-${tab.id}`;
            contentElement.className = 'tab-content hidden';
            contentElement.innerHTML = `
                <div class="collapse collapse-arrow bg-blue-100">
                    <input type="checkbox" checked />
                    <div class="collapse-title text-xl font-medium">
                        üìÅ <span id="currentPath-${tab.id}">${tab.path === '' ? '/' : '/' + tab.path}</span>
                    </div>
                    <div class="collapse-content">
                        <div id="backButton-${tab.id}" class="mb-2 ${tab.path === '' ? 'hidden' : ''}">
                            <button onclick="navigateBack()" class="btn btn-sm btn-outline">
                                ‚Üê Back
                            </button>
                        </div>
                        <ul class="menu bg-base-100 rounded-box p-2" id="fileList-${tab.id}">
                        </ul>
                        <div id="loadingSpinner-${tab.id}" class="flex justify-center items-center p-4 hidden">
                            <span class="loading loading-spinner loading-md text-blue-600"></span>
                            <span class="ml-2 text-sm text-gray-600">Loading files...</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('tabContentContainer').appendChild(contentElement);
        }

        function switchToTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('tab-active'));
            
            // Show selected tab content
            document.getElementById(`tab-content-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-header-${tabId}`).classList.add('tab-active');
            
            activeTabId = tabId;
            
            // Connect WebSocket if not already connected
            const tab = tabs.get(tabId);
            if (!tab.ws) {
                connectWebSocket(tab.path);
            }
        }

        function closeTab(tabId) {
            const tab = tabs.get(tabId);
            if (tab.ws) {
                tab.ws.close();
            }
            
            // Remove DOM elements
            document.getElementById(`tab-header-${tabId}`).remove();
            document.getElementById(`tab-content-${tabId}`).remove();
            
            // Remove from state
            tabs.delete(tabId);
            
            // Switch to another tab if this was active
            if (activeTabId === tabId) {
                const remainingTabs = Array.from(tabs.keys());
                if (remainingTabs.length > 0) {
                    switchToTab(remainingTabs[0]);
                } else {
                    // Create new tab if no tabs left
                    createTab();
                }
            }
        }

        function addNewTab() {
            const currentTab = tabs.get(activeTabId);
            const newPath = currentTab ? currentTab.path : '';
            createTab(newPath);
        }

        // WebSocket and navigation functions (updated to work with active tab)
        function getActiveTab() {
            return tabs.get(activeTabId);
        }

        function showSpinner() {
            const tab = getActiveTab();
            if (tab) {
                document.getElementById(`loadingSpinner-${tab.id}`).classList.remove('hidden');
            }
        }

        function hideSpinner() {
            const tab = getActiveTab();
            if (tab) {
                document.getElementById(`loadingSpinner-${tab.id}`).classList.add('hidden');
                setTimeout(reinitializeLightbox, 100);
            }
        }

        function updateBackButton() {
            const tab = getActiveTab();
            if (tab) {
                const backBtn = document.getElementById(`backButton-${tab.id}`);
                if (tab.path === '') {
                    backBtn.classList.add('hidden');
                } else {
                    backBtn.classList.remove('hidden');
                }
            }
        }

        function clearFileList() {
            const tab = getActiveTab();
            if (tab) {
                document.getElementById(`fileList-${tab.id}`).innerHTML = '';
                tab.hasFolders = false;
                tab.hasFiles = false;
                tab.dividerAdded = false;
            }
        }

        function appendToFileList(html) {
            const tab = getActiveTab();
            if (tab) {
                document.getElementById(`fileList-${tab.id}`).insertAdjacentHTML('beforeend', html);
            }
        }

        function addDividerIfNeeded() {
            const tab = getActiveTab();
            if (tab && tab.hasFolders && tab.hasFiles && !tab.dividerAdded) {
                appendToFileList(dividerTemplate());
                tab.dividerAdded = true;
            }
        }

        function handleMessage(event) {
            try {
                const data = JSON.parse(event.data);
                const tab = getActiveTab();
                if (!tab) return;

                if (Array.isArray(data) && data.length === 0) {
                    hideSpinner();
                    return;
                }

                if (Array.isArray(data) && data.length > 0) {
                    showSpinner();
                }

                data.forEach(item => {
                    if (item.type === 'folder') {
                        if (!tab.hasFolders) {
                            tab.hasFolders = true;
                        }
                        appendToFileList(folderTemplate(item.name, item.path));
                    } else if (item.type === 'file') {
                        if (!tab.hasFiles) {
                            tab.hasFiles = true;
                            addDividerIfNeeded();
                        }
                        appendToFileList(fileTemplate(item.name, item.path));
                    }
                });

            } catch (error) {
                console.error('Error parsing WebSocket message:', error);
            }
        }

        function connectWebSocket(path) {
            const tab = getActiveTab();
            if (!tab) return;

            if (tab.ws) {
                tab.ws.close();
            }

            clearFileList();
            showSpinner();

            tab.path = path;
            const displayPath = path === '' ? '/' : '/' + path;
            document.getElementById(`currentPath-${tab.id}`).textContent = displayPath;
            document.getElementById(`tab-header-${tab.id}`).querySelector('span').textContent = `üìÅ ${displayPath}`;
            updateBackButton();

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/files?path=${encodeURIComponent(path)}`;

            tab.ws = new WebSocket(wsUrl);
            tab.ws.onopen = () => console.log('WebSocket connected for path:', path);
            tab.ws.onmessage = handleMessage;
            tab.ws.onclose = () => {
                console.log('WebSocket disconnected');
                hideSpinner();
            };
            tab.ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                hideSpinner();
            };
        }

        function navigateToFolder(folderPath) {
            connectWebSocket(folderPath);
        }

        function navigateBack() {
            const tab = getActiveTab();
            if (!tab || tab.path === '') return;

            const pathParts = tab.path.split('/');
            pathParts.pop();
            const parentPath = pathParts.join('/');
            connectWebSocket(parentPath);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            reinitializeLightbox();
            
            // Add event listener for new tab button
            document.getElementById('addTabBtn').addEventListener('click', addNewTab);
            
            // Create initial tab
            createTab();
        });
    </script>
</body>
</html>


